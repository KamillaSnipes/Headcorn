<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ‚Äî Decision Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8f9fa;
            color: #1a1a2e;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 220px;
            background: #fff;
            border-right: 1px solid #e8e8e8;
            padding: 20px 0;
            position: fixed;
            top: 0; left: 0; bottom: 0;
            z-index: 10;
        }
        .sidebar-brand { padding: 0 20px 20px; border-bottom: 1px solid #f0f0f0; margin-bottom: 8px; }
        .sidebar-brand h2 { font-size: 1.1rem; font-weight: 700; }
        .sidebar-brand .sub { font-size: 0.7rem; color: #999; margin-top: 2px; }
        .sidebar nav a {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 20px; color: #555; text-decoration: none;
            font-size: 0.85rem; font-weight: 500;
            border-left: 3px solid transparent; transition: all 0.15s;
        }
        .sidebar nav a:hover { background: #f8f9fa; color: #1a1a2e; }
        .sidebar nav a.active { background: #eef2ff; color: #4f46e5; border-left-color: #4f46e5; font-weight: 600; }
        .sidebar nav a .icon { font-size: 1rem; width: 20px; text-align: center; }

        .main { margin-left: 220px; flex: 1; padding: 28px 32px; max-width: 900px; }
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px;
        }
        .page-header h1 { font-size: 1.5rem; font-weight: 700; }

        .btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 10px 20px; border-radius: 8px; border: none;
            font-size: 0.85rem; font-weight: 500; cursor: pointer;
            text-decoration: none; transition: all 0.15s;
        }
        .btn-primary { background: #4f46e5; color: white; }
        .btn-primary:hover { background: #4338ca; }
        .btn-green { background: #16a34a; color: white; }
        .btn-green:hover { background: #15803d; }
        .btn-orange { background: #ea580c; color: white; }
        .btn-orange:hover { background: #c2410c; }
        .btn-outline { background: #fff; color: #555; border: 1px solid #ddd; }
        .btn-outline:hover { background: #f8f9fa; }
        .btn-lg { padding: 14px 28px; font-size: 0.95rem; }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #eee;
            margin-bottom: 16px;
        }
        .card-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.ok { background: #16a34a; }
        .status-dot.fail { background: #dc2626; }
        .status-dot.warn { background: #ea580c; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        .stat {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 14px;
            text-align: center;
            border: 1px solid #eee;
        }
        .stat-num { font-size: 1.6rem; font-weight: 700; }
        .stat-label { font-size: 0.7rem; color: #888; margin-top: 4px; }

        .sync-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .flash {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.85rem;
        }
        .flash-success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; }
        .flash-info { background: #eef2ff; border: 1px solid #c7d2fe; color: #3730a3; }

        .meta-text { font-size: 0.78rem; color: #999; margin-top: 8px; }
        .connected-text { color: #16a34a; font-size: 0.82rem; font-weight: 500; }
        .error-text { color: #dc2626; font-size: 0.82rem; }
        .warn-text { color: #ea580c; font-size: 0.82rem; }

        .help-text {
            margin-top: 16px;
            font-size: 0.8rem;
            color: #666;
            line-height: 1.6;
        }
        .help-text strong { color: #1a1a2e; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; padding: 16px; }
            .sync-actions { flex-direction: column; }
            .btn-lg { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="sidebar-brand">
        <h2>Decision Tracker</h2>
        <div class="sub">Headcorn ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è</div>
    </div>
    <nav>
        <a href="{{ url_for('index') }}"><span class="icon">üìä</span> Dashboard</a>
        <a href="{{ url_for('index') }}?status=overdue"><span class="icon">üî¥</span> –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</a>
        <a href="{{ url_for('index') }}?status=active"><span class="icon">üü°</span> –í —Ä–∞–±–æ—Ç–µ</a>
        <a href="{{ url_for('sync') }}" class="active"><span class="icon">üîÑ</span> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</a>
        <a href="{{ url_for('add') }}"><span class="icon">‚ûï</span> –ù–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ</a>
        <a href="{{ url_for('api_decisions') }}"><span class="icon">üì°</span> API</a>
    </nav>
</aside>

<main class="main">
    <div class="page-header">
        <h1>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h1>
        <a href="{{ url_for('index') }}" class="btn btn-outline">‚Üê Dashboard</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
    <div class="flash flash-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endwith %}

    <div class="card">
        <div class="card-title">
            <span class="status-dot {{ 'ok' if hub_ok else ('warn' if has_key else 'fail') }}"></span>
            Context Hub
        </div>
        {% if not has_key %}
        <p class="warn-text">‚ö†Ô∏è API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é <code>CONTEXT_HUB_KEY</code> –≤ Railway.</p>
        {% elif hub_ok %}
        <p class="connected-text">‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</p>
        <p class="meta-text">{{ hub_url }}</p>
        {% if hub_stats and hub_stats is mapping %}
        <div class="stats-grid">
            <div class="stat">
                <div class="stat-num">{{ hub_stats.get('total', 0) }}</div>
                <div class="stat-label">–í Context Hub</div>
            </div>
            <div class="stat">
                {% set by_status = hub_stats.get('byStatus', {}) %}
                <div class="stat-num" style="color:#ca8a04;">{{ by_status.get('active', 0) if by_status is mapping else 0 }}</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
            </div>
            <div class="stat">
                <div class="stat-num" style="color:#dc2626;">{{ hub_stats.get('overdue', 0) }}</div>
                <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
            </div>
            <div class="stat">
                <div class="stat-num" style="color:#16a34a;">{{ hub_stats.get('verified', 0) }}</div>
                <div class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
            </div>
        </div>
        {% endif %}
        {% else %}
        <p class="error-text">‚úó –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Context Hub</p>
        <p class="meta-text">{{ hub_url }}</p>
        {% endif %}
    </div>

    <div class="card">
        <div class="card-title">üìä –õ–æ–∫–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</div>
        <div class="stats-grid">
            <div class="stat">
                <div class="stat-num">{{ local_count }}</div>
                <div class="stat-label">–í—Å–µ–≥–æ —Ä–µ—à–µ–Ω–∏–π</div>
            </div>
            <div class="stat">
                <div class="stat-num" style="color:#16a34a;">{{ local_with_hub }}</div>
                <div class="stat-label">–°–≤—è–∑–∞–Ω—ã —Å Hub</div>
            </div>
            <div class="stat">
                <div class="stat-num" style="color:#ea580c;">{{ local_only }}</div>
                <div class="stat-label">–¢–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ</div>
            </div>
        </div>
        {% if last_sync %}
        <p class="meta-text" style="margin-top: 12px;">
            –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: {{ last_sync.timestamp[:16].replace('T', ' ') }}
            ({{ last_sync.action.replace('sync_pull', '‚Üê –∑–∞–≥—Ä—É–∑–∫–∞').replace('sync_push', '‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞') }},
            {{ last_sync.count }} —à—Ç.)
        </p>
        {% endif %}
    </div>

    {% if has_key and hub_ok %}
    <div class="card">
        <div class="card-title">‚ö° –î–µ–π—Å—Ç–≤–∏—è</div>
        <div class="sync-actions">
            <form method="POST"><input type="hidden" name="action" value="pull">
                <button type="submit" class="btn btn-green btn-lg">‚¨áÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Context Hub</button>
            </form>
            <form method="POST"><input type="hidden" name="action" value="push">
                <button type="submit" class="btn btn-orange btn-lg">‚¨ÜÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Context Hub</button>
            </form>
            <form method="POST"><input type="hidden" name="action" value="full">
                <button type="submit" class="btn btn-primary btn-lg">üîÑ –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
            </form>
        </div>
        <div class="help-text">
            <strong>‚¨áÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å</strong> ‚Äî –Ω–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏–∑ Context Hub –ø–æ—è–≤—è—Ç—Å—è –≤ —Ç—Ä–µ–∫–µ—Ä–µ<br>
            <strong>‚¨ÜÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å</strong> ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è —É–π–¥—É—Ç –≤ Context Hub<br>
            <strong>üîÑ –ü–æ–ª–Ω–∞—è</strong> ‚Äî –æ–±–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞ –æ–¥–∏–Ω –∫–ª–∏–∫
        </div>
    </div>
    {% endif %}
</main>
</body>
</html>
